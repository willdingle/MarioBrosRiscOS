#include "Enemy.h"
#include "Level.h"

#include <stdio.h>

void updateShellcreeperAnimation(Shellcreeper *shellcreeper)
{
	shellcreeper->frame++;
	
	if (shellcreeper->frame % 4 == 0)
	{
		if (shellcreeper->xSpeed == shellcreeper->xMaxSpeed && !shellcreeper->inHitState)
		{
			if (shellcreeper->curFrame == shellcreeper->walk0Frame || shellcreeper->curFrame == shellcreeper->walk1Frame)
				shellcreeper->curFrame = shellcreeper->stillFrame;
			else if (shellcreeper->curFrame == shellcreeper->stillFrame)
			{
				if (shellcreeper->lastWalk == 0)
				{
					shellcreeper->curFrame = shellcreeper->walk1Frame;
					shellcreeper->lastWalk = 1;
				}
				else
				{
					shellcreeper->curFrame = shellcreeper->walk0Frame;
					shellcreeper->lastWalk = 0;
				}
			}
		}
		else
		{
			if (shellcreeper->curFrame == shellcreeper->hit0Frame)
				shellcreeper->curFrame = shellcreeper->hit1Frame;
			else
				shellcreeper->curFrame = shellcreeper->hit0Frame;
		}
	}
}

void updateShellcreeper(Shellcreeper *shellcreeper, Level *level, osspriteop_area *area, void *logFile)
{
	//Apply falling
	if (shellcreeper->isFalling && !(shellcreeper->inPipe))
	{
		shellcreeper->ySpeed += -0.5;
		shellcreeper->y += shellcreeper->ySpeed;
	}
	
	//Movement
	if (!shellcreeper->inHitState && !shellcreeper->dying)
	{
		if (shellcreeper->facing == 'L')
			shellcreeper->x -= shellcreeper->xSpeed;
		else if (shellcreeper->facing == 'R')
			shellcreeper->x += shellcreeper->xSpeed;
	}
	else if (shellcreeper->dying)
	{
		shellcreeper->x += shellcreeper->xSpeed;
	}
	
	//Animation
	if (!(shellcreeper->isFalling))
	{
		updateShellcreeperAnimation(shellcreeper);
	}
	
	//Platform collision
	if (!shellcreeper->dying)
	{
		scPlatCollision(shellcreeper, level, logFile);
	}
	
	//Check if walked off platform
	if (!(shellcreeper->isFalling) && !(shellcreeper->isOnPlat) && shellcreeper->y + 16*4 > 1)
	{
		shellcreeper->isFalling = 1;
		shellcreeper->ySpeed = -6.0;
	}
	
	//Check if on ground level, in a pipe or other
	int shY = (int) (shellcreeper->y);
	switch (shY)
	{
		//Ground
		case 16*4:
			//Left pipe check
			if (shellcreeper->facing == 'L' && shellcreeper->x <= 32*4)
			{
				shellcreeper->y = 24*4;
				shellcreeper->inPipe = 1;
			}
			//Right pipe check
			else if (shellcreeper->facing == 'R' && shellcreeper->x + (shellcreeper->width * 4) >= 1024 - 32*4)
			{
				shellcreeper->y = 24*4;
				shellcreeper->inPipe = 1;
			}
			break;
		
		//In pipe
		case 24*4:
			//Left pipe
			if (shellcreeper->facing == 'L' && shellcreeper->x + (shellcreeper->width * 4) < 32*4)
			{
				shellcreeper->x = 48*4;
				shellcreeper->y = 178*4;
				shellcreeper->facing = 'R';
				shellcreeper->isFalling = 1;
				shellcreeper->inPipe = 0;
			}
			//Right pipe
			else if (shellcreeper->facing == 'R' && shellcreeper->x > 1024 - 32*4)
			{
				shellcreeper->x = 1024 - 48*4 - shellcreeper->width * 4;
				shellcreeper->y = 178*4;
				shellcreeper->facing = 'L';
				shellcreeper->isFalling = 1;
				shellcreeper->inPipe = 0;
			}
			break;
			
		//Other
		default:
			//Bounds - wrap around to other side when going off left or right side of screen
			if (shellcreeper->facing == 'L' && shellcreeper->x + 12 * 4 < 0)
			{
				shellcreeper->x = 1024;
			}
			else if (shellcreeper->facing == 'R' && shellcreeper->x > 1024)
			{
				shellcreeper->x = 0 - 16*4;
			}
			break;
	}
	
	//Make shellcreeper dead when it as a whole reaches or goes below y = 0
	if (shellcreeper->y + shellcreeper->height * 4 <= 0 && shellcreeper->dying)
	{
		shellcreeper->dying = 0;
		shellcreeper->dead = 1;
	}
}

void scPlatCollision(Shellcreeper *shellcreeper, Level *level, void *logFile)
{
	float objX = shellcreeper->x;
	float objY = shellcreeper->y;
	float objWidth = shellcreeper->width * 4;
	float objHeight = shellcreeper->height * 4;
	
	//fprintf((FILE*) logFile, "%f,\t%f,\t%f,\t%f\n", objX, objY, objWidth, objHeight);
	
	int onPlatDetected = 0;

	for (int i = 0; i < 8; i++)
	{
		float platX = level->plats[i].x;
		float platY = level->plats[i].y;
		float platWidth = level->plats[i].width;
		float platHeight = level->plats[i].height;
		
		//Downwards y platform collision
		if ((objX <= platX + platWidth && objX + objWidth >= platX && objY <= platY + platHeight && objY >= platY) && !(shellcreeper->ySpeed > 0))
		{
			shellcreeper->y = platY + platHeight;
			shellcreeper->ySpeed = 0;
			shellcreeper->isFalling = 0;
			shellcreeper->isOnPlat = 1;
			onPlatDetected = 1;
			
			//Check if this platform has been hit
			enum PlatRow thisPlatRow;
			getPlatRow(&thisPlatRow, i);
			if (thisPlatRow == level->platRow)
			{
				float midOfSc = (objX + (objX + objWidth)) / 2;
				int thisPlatSquare = (int) ((midOfSc - level->plats[i].x) / level->platSize / 4);
				if (thisPlatSquare == level->platSquare)
				{
					fprintf((FILE*)logFile, "Shellcreeper hit\n");
					shellcreeper->inHitState = 1;
					shellcreeper->curFrame = shellcreeper->hit0Frame;
					shellcreeper->ySpeed = 5.0;
					shellcreeper->isFalling = 1;
				}
			}
		}
	}
	
	//Update if object is on platform
	if (shellcreeper->isOnPlat && !onPlatDetected)
	{
		shellcreeper->isOnPlat = 0;
	}
}