#include "Window.h"

#include <string.h>

void redrawWindow(wimp_block *block, osspriteop_area *area, Player *mario, Shellcreeper *shellcreeper, Level *level, os_factors *factors, FILE *logFile)
{
	wimp_draw draw;
	
	draw.w = block->redraw.w;
	draw.box = block->redraw.box;
	
	int more;
	
	xwimp_redraw_window(&draw, &more);
	
	while (more)
	{
		int x = draw.box.x0 - draw.xscroll;
		int y = draw.box.y1 - draw.yscroll;
		
		//Draw level
		os_error *e = xosspriteop_put_sprite_scaled(
			osspriteop_PTR,
			area,
			(osspriteop_id) level->floor,
			x,
			y,
			os_ACTION_OVERWRITE | osspriteop_GIVEN_WIDE_ENTRIES | 0x8,
			factors,
			mario->mainTransTab
		);
		
		if (e != NULL)
		{
			fprintf(logFile, "Put level floor failed\n"
				"	errnum = %d: message = '%s'\n", e->errnum, e->errmess);
			fflush(logFile);
		}
		
		e = xosspriteop_put_sprite_scaled(
			osspriteop_PTR,
			area,
			(osspriteop_id) level->pipeBottom,
			x + 1024 - (32*4),
			y + (25 * 4),
			os_ACTION_OVERWRITE | osspriteop_GIVEN_WIDE_ENTRIES | 0x8,
			factors,
			mario->mainTransTab
		);
		
		if (e != NULL)
		{
			fprintf(logFile, "Put pipe bottom right failed\n"
				"	errnum = %d: message = '%s'\n", e->errnum, e->errmess);
			fflush(logFile);
		}
		
		osspriteop_flip_about_yaxis(osspriteop_USER_AREA, area, (osspriteop_id) "pipe_bottom");
		
		e = xosspriteop_put_sprite_scaled(
			osspriteop_PTR,
			area,
			(osspriteop_id) level->pipeBottom,
			x,
			y + (25 * 4),
			os_ACTION_OVERWRITE | osspriteop_GIVEN_WIDE_ENTRIES | 0x8,
			factors,
			mario->mainTransTab
		);
		
		if (e != NULL)
		{
			fprintf(logFile, "Put pipe bottom left failed\n"
				"	errnum = %d: message = '%s'\n", e->errnum, e->errmess);
			fflush(logFile);
		}
		
		osspriteop_flip_about_yaxis(osspriteop_USER_AREA, area, (osspriteop_id) "pipe_bottom");
		
		e = xosspriteop_put_sprite_scaled(
			osspriteop_PTR,
			area,
			(osspriteop_id) level->pipeTop,
			x + 1024 - (48*4),
			y + 896 - (56*4),
			os_ACTION_OVERWRITE | osspriteop_GIVEN_WIDE_ENTRIES | 0x8,
			factors,
			mario->mainTransTab
		);
		
		if (e != NULL)
		{
			fprintf(logFile, "Put pipe top right failed\n"
				"	errnum = %d: message = '%s'\n", e->errnum, e->errmess);
			fflush(logFile);
		}
		
		osspriteop_flip_about_yaxis(osspriteop_USER_AREA, area, (osspriteop_id) "pipe_top");
		
		e = xosspriteop_put_sprite_scaled(
			osspriteop_PTR,
			area,
			(osspriteop_id) level->pipeTop,
			x,
			y + 896 - (56*4),
			os_ACTION_OVERWRITE | osspriteop_GIVEN_WIDE_ENTRIES | 0x8,
			factors,
			mario->mainTransTab
		);
		
		if (e != NULL)
		{
			fprintf(logFile, "Put pipe top left failed\n"
				"	errnum = %d: message = '%s'\n", e->errnum, e->errmess);
			fflush(logFile);
		}
		
		osspriteop_flip_about_yaxis(osspriteop_USER_AREA, area, (osspriteop_id) "pipe_top");
		
		//Draw player
		e = xosspriteop_put_sprite_scaled(
			osspriteop_PTR,
			area,
			(osspriteop_id) mario->curFrame,
			x + mario->x,
			y + mario->y,
			os_ACTION_OVERWRITE | osspriteop_GIVEN_WIDE_ENTRIES | 0x8,
			factors,
			mario->curTransTab
		);
		
		if (e != NULL)
		{
			fprintf(logFile, "Put mario failed\n"
				"	errnum = %d: message = '%s'\n", e->errnum, e->errmess);
			fflush(logFile);
		}
		
		//Draw enemies
		e = xosspriteop_put_sprite_scaled(
			osspriteop_PTR,
			area,
			(osspriteop_id) shellcreeper->curFrame,
			x + shellcreeper->x,
			y + shellcreeper->y,
			os_ACTION_OVERWRITE | osspriteop_GIVEN_WIDE_ENTRIES | 0x8,
			factors,
			shellcreeper->transTab
		);
		
		if (e != NULL)
		{
			fprintf(logFile, "Put shellcreeper failed\n"
				"	errnum = %d: message = '%s'\n", e->errnum, e->errmess);
			fflush(logFile);
		}
		
		xwimp_get_rectangle(&draw, &more);
	}
}

void loadWindowIntoBlock(wimp_window **window, wimp_block **block)
{
	(*block)->open.w = wimp_create_window(*window);
	(*block)->open.visible = (*window)->visible;
	(*block)->open.xscroll = (*window)->xscroll;
	(*block)->open.yscroll = (*window)->yscroll;
	(*block)->open.next = (*window)->next;
}

void addIconToBar()
{
	wimp_icon_create IBCr;
	IBCr.w = wimp_ICON_BAR_RIGHT;
	IBCr.icon.extent.x0 = 0;
	IBCr.icon.extent.y0 = 0;
	IBCr.icon.extent.x1 = 68;
	IBCr.icon.extent.y1 = 68;
	IBCr.icon.flags = wimp_ICON_SPRITE | wimp_BUTTON_CLICK << wimp_ICON_BUTTON_TYPE_SHIFT;
	strncpy(IBCr.icon.data.sprite, "mario_still", 12);
	wimp_create_icon(&IBCr);
}